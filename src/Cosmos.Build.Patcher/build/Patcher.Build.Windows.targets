<Project>

  <PropertyGroup>
    <!--
      Windows only: if not overridden, assume the global Cosmos.Patcher
      tool is installed at %USERPROFILE%\.dotnet\tools\cosmos.patcher.exe
    -->
    <CosmosPatcherExe Condition="'$(CosmosPatcherExe)' == ''">$(USERPROFILE)\.dotnet\tools\cosmos.patcher.exe</CosmosPatcherExe>
  </PropertyGroup>

  <!-- Windows -->
  <Target Name="RunPatcher"
        AfterTargets="Build"
        DependsOnTargets="SetupPatcher"
        Condition="'$(EnablePatching)' == 'true'"
        Inputs="@(AssembliesToPatch->'%(Identity)')"
        Outputs="@(AssembliesToPatch->'%(PatcherOutputPath)')">
    <Message Importance="High" Text="Batch patching: %(AssembliesToPatch.Identity) -> %(AssembliesToPatch.PatcherOutputPath)" />
    <Message Text="▶ Running Patch…" Importance="High" />
    <Exec
      Command="$(CosmosPatcherExe) patch --target &quot;@(AssembliesToPatch)&quot; --output &quot;%(AssembliesToPatch.PatcherOutputPath)&quot; --plugs @(PlugRef->'%(Identity)')"
      IgnoreExitCode="true">
      <Output TaskParameter="ExitCode" PropertyName="PatcherExitCode" />
      <Output TaskParameter="ConsoleOutput" PropertyName="PatcherConsoleOutput" />
    </Exec>

    <Error Condition="'$(PatcherExitCode)' != '0'"
           Text="Cosmos.Patcher failed for &quot;%(AssembliesToPatch.Identity)&quot; code=$(PatcherExitCode): $(PatcherConsoleOutput)" />
    <Message Importance="High"
             Text="✅ Cosmos.Patcher successfully patched: %(AssembliesToPatch.PatcherOutputPath)"
             Condition="'$(PatcherExitCode)' == '0'" />
  </Target>

</Project>
